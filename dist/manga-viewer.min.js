const ICONS={chevronLeft:'<svg viewBox="0 0 320 512" width="14" height="14" fill="currentColor"><path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z"/></svg>',expand:'<svg viewBox="0 0 448 512" width="14" height="14" fill="currentColor"><path d="M32 32C14.3 32 0 46.3 0 64v96c0 17.7 14.3 32 32 32s32-14.3 32-32V96h64c17.7 0 32-14.3 32-32s-14.3-32-32-32H32zM64 416H32c-17.7 0-32-14.3-32-32V288c0-17.7 14.3-32 32-32s32 14.3 32 32v64h64c17.7 0 32 14.3 32 32s-14.3 32-32 32zm320-320c17.7 0 32-14.3 32-32s-14.3-32-32-32H320c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7 14.3 32 32 32s32-14.3 32-32V64zM384 416h-64c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v96z"/></svg>',compress:'<svg viewBox="0 0 448 512" width="14" height="14" fill="currentColor"><path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32v64H32c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32V64zM32 384c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v64c0 17.7 14.3 32 32 32s32-14.3 32-32V384c0-17.7-14.3-32-32-32H32zM352 448h-64c-17.7 0-32 14.3-32 32v96c0 17.7 14.3 32 32 32s32-14.3 32-32v-64h64c17.7 0 32-14.3 32-32s-14.3-32-32-32zM288 160c0 17.7 14.3 32 32 32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H352V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v96z"/></svg>',xLogo:'<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>',link:'<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',question:'<svg viewBox="0 0 320 512" width="14" height="14" fill="currentColor"><path d="M80 160c0-35.3 28.7-64 64-64h32c35.3 0 64 28.7 64 64v3.6c0 21.8-11.1 42.1-29.4 53.8l-42.2 27.1A87.983 87.983 0 0 0 128 313v7c0 17.7 14.3 32 32 32s32-14.3 32-32v-7c0-7.4 3.6-14.3 9.6-18.5l42.2-27.1C274 237.3 272 196.2 272 163.6V160c0-70.7-57.3-128-128-128H112C41.3 32 -16 89.3-16 160c0 17.7 14.3 32 32 32s32-14.3 32-32zm80 320a40 40 0 1 0 0-80 40 40 0 1 0 0 80z"/></svg>',bookmark:'<svg viewBox="0 0 384 512" width="14" height="14" fill="currentColor"><path d="M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4 13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"/></svg>',searchPlus:'<svg viewBox="0 0 512 512" width="18" height="18" fill="currentColor"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM184 296c0 13.3 10.7 24 24 24s24-10.7 24-24V232h64c13.3 0 24-10.7 24-24s-10.7-24-24-24H232V120c0-13.3-10.7-24-24-24s-24 10.7-24 24v64H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h64v64z"/></svg>',compressAlt:'<svg viewBox="0 0 512 512" width="18" height="18" fill="currentColor"><path d="M456 224H312c-13.3 0-24-10.7-24-24V56c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2l40 40L442.3 5.7C454.8-6.8 475.2-6.8 487.7 5.7s12.5 32.8 0 45.3L414.4 124.3l40 40c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8zm0 64c9.7 0 18.5 5.8 22.2 14.8s1.7 19.3-5.2 26.2l-40 40 73.4 73.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L387.6 414.4l-40 40c-6.9 6.9-17.2 8.9-26.2 5.2s-14.8-12.5-14.8-22.2V312c0-13.3 10.7-24 24-24H456zM56 224c-9.7 0-18.5-5.8-22.2-14.8s-1.7-19.3 5.2-26.2l40-40L5.7 69.7C-6.8 57.2-6.8 36.8 5.7 24.3s32.8-12.5 45.3 0l73.4 73.4 40-40c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2V200c0 13.3-10.7 24-24 24H56zm0 64H200c13.3 0 24 10.7 24 24V456c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-40-40L69.7 506.3C57.2 518.8 36.8 518.8 24.3 506.3s-12.5-32.8 0-45.3l73.4-73.4-40-40c-6.9-6.9-8.9-17.2-5.2-26.2S46.3 288 56 288z"/></svg>',check:'<svg viewBox="0 0 512 512" width="14" height="14" fill="currentColor"><path d="M470.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L192 338.7 425.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>',questionCircle:'<svg viewBox="0 0 512 512" width="18" height="18" fill="currentColor"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM169.8 165.3c7.9-22.3 29.1-37.3 52.8-37.3h58.3c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24V250.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1H222.6c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/></svg>',times:'<svg viewBox="0 0 384 512" width="14" height="14" fill="currentColor"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3l105.4 105.3c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256l105.3-105.4z"/></svg>',play:'<svg viewBox="0 0 384 512" width="14" height="14" fill="currentColor"><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.8 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg>'},MANGA_VIEWER_CSS=String.raw`/**
 * Manga Viewer v0.2.0
 * https://github.com/tokagemushi/manga-viewer
 * (c) tokagemushi — MIT License
 */

/* ===== Reset / Base ===== */
.mv-loading-screen {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #000;
  transition: opacity 0.4s ease, visibility 0.4s ease;
}

@media (max-width: 768px) {
  .mv-loading-screen { background: #fff; }
}

.mv-loading-screen.mv-fade-out {
  opacity: 0;
  visibility: hidden;
}

.mv-loading-spinner {
  width: 48px;
  height: 48px;
  border: 3px solid rgba(250, 204, 21, 0.2);
  border-top-color: #facc15;
  border-radius: 50%;
  animation: mv-spin 0.8s linear infinite;
}

@media (max-width: 768px) {
  .mv-loading-spinner {
    border-color: rgba(100, 100, 100, 0.2);
    border-top-color: #666;
  }
}

.mv-loading-text {
  margin-top: 16px;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
}

@media (max-width: 768px) {
  .mv-loading-text { color: rgba(0, 0, 0, 0.5); }
}

@keyframes mv-spin {
  to { transform: rotate(360deg); }
}

/* ===== Container ===== */
.mv-container {
  position: fixed;
  inset: 0;
  height: 100dvh;
  background: #000;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.5;
  color: #fff;
  -webkit-text-size-adjust: 100%;
  box-sizing: border-box;
}

.mv-container *, .mv-container *::before, .mv-container *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

@media (max-width: 768px) {
  .mv-container { background: #fff; }
}

.mv-container.mv-pseudo-fullscreen {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  height: 100dvh;
  z-index: 9999;
}

body.mv-pseudo-fullscreen-body {
  overflow: hidden;
}

/* ===== Status Bar Cover (mobile notch) ===== */
.mv-status-bar-cover {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: env(safe-area-inset-top, 0px);
  background: #fff;
  z-index: 45;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}

.mv-status-bar-cover.mv-visible { opacity: 1; }

@media (min-width: 769px) {
  .mv-status-bar-cover { display: none; }
}

/* ===== Header ===== */
.mv-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: auto;
  padding: 8px 12px;
  padding-top: max(8px, env(safe-area-inset-top));
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 50;
  background: rgba(40, 40, 40, 0.95);
  opacity: 1;
  transition: opacity 0.3s ease;
}

@media (max-width: 768px) {
  .mv-header {
    background: rgba(245, 245, 245, 0.98);
  }
  .mv-header .mv-title { color: #333 !important; }
}

.mv-header.mv-ui-hidden {
  opacity: 0;
  pointer-events: none;
}

.mv-header.mv-hidden {
  display: none !important;
}

.mv-title {
  color: #fff;
  font-weight: bold;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  text-align: center;
  margin: 0 12px;
}

.mv-header-buttons {
  display: flex;
  align-items: center;
  gap: 8px;
}

.mv-header-btn {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.08);
  border: none;
  color: rgba(255, 255, 255, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  text-decoration: none;
}

.mv-header-btn:hover {
  background: rgba(255, 255, 255, 0.15);
}

.mv-header-btn svg {
  width: 16px;
  height: 16px;
  fill: currentColor;
}

@media (max-width: 768px) {
  .mv-header-btn {
    width: 32px;
    height: 32px;
    font-size: 13px;
    background: rgba(0, 0, 0, 0.06);
    color: #333;
  }
  .mv-header-btn:hover { background: rgba(0, 0, 0, 0.1); }
  .mv-header-btn svg { fill: #333; }
  .mv-title { font-size: 13px; }
}

/* ===== Footer ===== */
.mv-footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 8px 12px;
  padding-bottom: max(8px, env(safe-area-inset-bottom));
  z-index: 50;
  background: rgba(40, 40, 40, 0.95);
  opacity: 1;
  transition: opacity 0.3s ease;
}

@media (max-width: 768px) {
  .mv-footer {
    background: rgba(245, 245, 245, 0.98);
    padding: 10px 16px 16px 16px;
    padding-bottom: max(16px, calc(env(safe-area-inset-bottom) + 8px));
  }
  .mv-footer .mv-footer-info,
  .mv-footer span { color: #333 !important; }
}

.mv-footer.mv-ui-hidden {
  opacity: 0;
  pointer-events: none;
}

.mv-footer.mv-hidden {
  display: none !important;
}

.mv-footer-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
  color: #fff;
  font-size: 12px;
}

.mv-footer-info span {
  opacity: 0.7;
}

/* ===== Slider ===== */
.mv-page-slider {
  width: 100%;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
}

@media (max-width: 768px) {
  .mv-page-slider {
    background: rgba(0, 0, 0, 0.15);
    height: 8px;
    margin-top: 4px;
  }
}

.mv-page-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 18px;
  height: 18px;
  background: #facc15;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.mv-page-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #facc15;
  border-radius: 50%;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

@media (max-width: 768px) {
  .mv-page-slider::-webkit-slider-thumb { width: 22px; height: 22px; }
  .mv-page-slider::-moz-range-thumb { width: 22px; height: 22px; }
}

.mv-page-slider.mv-rtl-slider {
  direction: rtl;
}

/* ===== Main Viewer Area ===== */
.mv-main {
  position: absolute;
  inset: 0;
  overflow: hidden;
  background: #000;
}

@media (max-width: 768px) {
  .mv-main { background: #fff; }
}

.mv-main.mv-scroll-mode {
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}

/* ===== Slot Track ===== */
.mv-slot-track {
  display: flex;
  width: 100%;
  height: 100%;
  transform: var(--mv-track-transform, translateX(0px));
  transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.mv-slot-track.mv-no-transition {
  transition: none;
}

.mv-slot-track.mv-scroll-track {
  flex-direction: column;
  height: auto;
  transition: none;
}

/* ===== Page Slot ===== */
.mv-page-slot {
  flex: 0 0 100%;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}

@media all and (display-mode: standalone) {
  .mv-page-slot {
    padding-bottom: env(safe-area-inset-top, 0px);
  }
}

.mv-scroll-track .mv-page-slot {
  flex: 0 0 auto;
  height: auto;
  min-height: auto;
}

/* ===== Zoom Container ===== */
.mv-zoom-container {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  transform-origin: center center;
  transform: var(--mv-zoom-transform, scale(1) translate(0px, 0px));
  touch-action: none;
  transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.mv-zoom-container.mv-no-transition {
  transition: none !important;
}

/* ===== Page Images ===== */
.mv-page-slot img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  -webkit-user-drag: none;
  pointer-events: auto;
  display: block;
}

.mv-scroll-track .mv-page-slot img {
  width: 100%;
  height: auto;
  max-height: none;
}

/* ===== Blank page for single-page-in-spread ===== */
.mv-spread-slot .mv-blank-page {
  height: 100%;
  width: auto;
  aspect-ratio: var(--mv-blank-aspect-ratio, auto);
  max-width: 50%;
  max-height: 100%;
  background: #000;
}

.mv-page-fill {
  width: 100%;
  height: 100%;
}

.mv-page-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

.mv-page-bg {
  background: var(--mv-page-bg, transparent);
}

.mv-page-link {
  text-decoration: none;
}

.mv-display-none {
  display: none !important;
}

.mv-adsense-page {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.mv-adsense-inner {
  width: 100%;
  max-width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.mv-adsense-slot {
  display: block;
  min-width: 300px;
  min-height: 250px;
  width: 100%;
}

.mv-adsense-label {
  margin-top: 20px;
  color: #666;
  font-size: 12px;
  text-align: center;
}

.mv-purchase-trigger {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

/* ===== Spread Mode ===== */
.mv-page-slot.mv-spread-slot {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
}

.mv-page-slot.mv-spread-slot .mv-zoom-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
}

.mv-page-slot.mv-spread-slot img {
  height: 100%;
  width: auto;
  max-width: 50%;
  max-height: 100%;
}

.mv-page-slot.mv-spread-slot.mv-rtl-slot .mv-zoom-container {
  flex-direction: row-reverse;
}

/* ===== Tap Areas ===== */
.mv-tap-area {
  position: absolute;
  top: 0;
  bottom: 0;
  z-index: 10;
}

.mv-tap-area.mv-left { left: 0; width: 30%; }
.mv-tap-area.mv-right { right: 0; width: 30%; }
.mv-tap-area.mv-center { left: 30%; width: 40%; }

/* ===== Zoom Controls ===== */
.mv-zoom-controls {
  position: fixed;
  bottom: 100px;
  right: 16px;
  z-index: 60;
  display: none;
  flex-direction: column;
  gap: 8px;
  transition: opacity 0.3s ease;
}

.mv-zoom-controls.mv-ui-hidden {
  opacity: 0;
  pointer-events: none;
}

@media (min-width: 769px) {
  .mv-zoom-controls { display: flex; }
}

@media (max-width: 768px) {
  .mv-zoom-controls { display: none !important; }
}

.mv-zoom-btn {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 18px;
}

.mv-zoom-btn:hover {
  background: rgba(250, 204, 21, 0.8);
  color: black;
}

.mv-zoom-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.mv-zoom-btn:disabled:hover {
  background: rgba(0, 0, 0, 0.6);
  color: white;
}

/* ===== Resume Dialog ===== */
.mv-resume-dialog {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  animation: mv-fadeIn 0.3s ease;
}

@keyframes mv-fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.mv-resume-card {
  background: white;
  border-radius: 24px;
  padding: 32px;
  max-width: 340px;
  width: 100%;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  animation: mv-slideUp 0.3s ease;
}

@keyframes mv-slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.mv-resume-icon {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
}

.mv-resume-icon svg {
  width: 28px;
  height: 28px;
  fill: #fff;
}

.mv-resume-title {
  color: #1f2937;
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 8px;
}

.mv-resume-subtitle {
  color: #6b7280;
  font-size: 14px;
  margin-bottom: 24px;
}

.mv-resume-buttons {
  display: flex;
  gap: 12px;
}

.mv-resume-btn {
  flex: 1;
  padding: 14px 16px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
}

.mv-resume-btn.mv-primary {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: #fff;
}

.mv-resume-btn.mv-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
}

.mv-resume-btn.mv-secondary {
  background: #f3f4f6;
  color: #374151;
  border: 1px solid #e5e7eb;
}

.mv-resume-btn.mv-secondary:hover {
  background: #e5e7eb;
}

/* ===== Help Overlay ===== */
.mv-help-overlay {
  position: fixed;
  inset: 0;
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.mv-help-card {
  background: rgba(30, 30, 30, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  max-width: 400px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

@media (max-width: 768px) {
  .mv-help-card { max-height: 70vh; }
}

.mv-help-header {
  padding: 20px 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.mv-help-title {
  color: #facc15;
  font-size: 20px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.mv-help-close {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: rgba(255, 255, 255, 0.6);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.mv-help-close:hover {
  background: rgba(255, 255, 255, 0.2);
  color: #fff;
}

.mv-help-content {
  padding: 20px 24px;
}

.mv-help-section {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.mv-help-section:last-child { margin-bottom: 0; }

.mv-help-section-title {
  color: #facc15;
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mv-help-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 10px;
}

.mv-help-item:last-child { margin-bottom: 0; }

.mv-help-item-icon {
  width: 32px;
  height: 32px;
  background: rgba(250, 204, 21, 0.15);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: #facc15;
  font-size: 14px;
}

.mv-help-item-text { flex: 1; }

.mv-help-item-label {
  color: #fff;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 2px;
}

.mv-help-item-desc {
  color: rgba(255, 255, 255, 0.5);
  font-size: 12px;
}

/* ===== Toast ===== */
.mv-toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(30, 30, 30, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color: #fff;
  padding: 10px 18px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 400;
  font-family: 'Zen Maru Gothic', "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
  letter-spacing: 0.02em;
  white-space: nowrap;
  text-align: center;
  max-width: 90vw;
  z-index: 300;
  display: flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  animation: mv-toastIn 0.3s ease;
}

.mv-toast.mv-fade-out {
  animation: mv-toastOut 0.3s ease forwards;
}

@keyframes mv-toastIn {
  from { opacity: 0; transform: translate(-50%, 20px); }
  to { opacity: 1; transform: translate(-50%, 0); }
}

@keyframes mv-toastOut {
  from { opacity: 1; transform: translate(-50%, 0); }
  to { opacity: 0; transform: translate(-50%, 20px); }
}

/* ===== Purchase Popup ===== */
.mv-purchase-popup {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
  pointer-events: none;
}

.mv-purchase-card {
  background: white;
  border-radius: 24px;
  padding: 32px;
  max-width: 380px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  text-align: center;
  pointer-events: auto;
}

.mv-purchase-icon {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, #22c55e, #10b981);
  border-radius: 50%;
  margin: 0 auto 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mv-purchase-title {
  font-size: 1.4rem;
  font-weight: bold;
  margin-bottom: 12px;
  color: #1f2937;
}

.mv-purchase-desc {
  color: #6b7280;
  margin-bottom: 6px;
  line-height: 1.5;
  font-size: 0.95rem;
}

.mv-purchase-btn {
  display: block;
  background: linear-gradient(135deg, #22c55e, #10b981);
  color: white;
  padding: 16px 32px;
  border-radius: 12px;
  font-weight: bold;
  font-size: 1.1rem;
  text-decoration: none;
  margin-bottom: 12px;
  margin-top: 24px;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
  border: none;
  cursor: pointer;
  width: 100%;
}

.mv-purchase-back {
  display: block;
  color: #6b7280;
  font-size: 0.9rem;
  padding: 8px 16px;
  text-decoration: none;
}

/* ===== Responsive helpers ===== */
@media (min-width: 769px) {
  .mv-mobile-only { display: none !important; }
}

@media (max-width: 768px) {
  .mv-pc-only { display: none !important; }
}

/* ===== Bookmark Button Active ===== */
.mv-bookmark-btn.mv-bookmark-active {
  color: #facc15 !important;
}

@media (max-width: 768px) {
  .mv-bookmark-btn.mv-bookmark-active {
    color: #f59e0b !important;
  }
  .mv-bookmark-btn.mv-bookmark-active svg {
    fill: #f59e0b !important;
  }
}

/* ===== Bookmark Panel Overlay ===== */
.mv-bookmark-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 90;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.mv-bookmark-overlay.mv-open {
  opacity: 1;
  visibility: visible;
}

/* ===== Bookmark Panel ===== */
.mv-bookmark-panel {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: 320px;
  max-width: 85vw;
  background: rgba(30, 30, 30, 0.98);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: 100;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

[dir="rtl"] .mv-bookmark-panel,
.mv-bookmark-panel.mv-rtl {
  right: auto;
  left: 0;
  transform: translateX(-100%);
}

.mv-bookmark-panel.mv-open {
  transform: translateX(0);
}

@media (max-width: 768px) {
  .mv-bookmark-panel {
    background: rgba(250, 250, 250, 0.98);
  }
}

/* Panel header */
.mv-bookmark-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  padding-top: max(16px, env(safe-area-inset-top));
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

@media (max-width: 768px) {
  .mv-bookmark-panel-header {
    border-bottom-color: rgba(0, 0, 0, 0.1);
  }
}

.mv-bookmark-panel-title {
  color: #fff;
  font-size: 18px;
  font-weight: 700;
}

@media (max-width: 768px) {
  .mv-bookmark-panel-title { color: #333; }
}

.mv-bookmark-panel-close {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: rgba(255, 255, 255, 0.6);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.mv-bookmark-panel-close:hover {
  background: rgba(255, 255, 255, 0.2);
  color: #fff;
}

@media (max-width: 768px) {
  .mv-bookmark-panel-close {
    background: rgba(0, 0, 0, 0.06);
    color: #666;
  }
  .mv-bookmark-panel-close:hover { background: rgba(0, 0, 0, 0.1); }
}

/* Toggle button (add/remove current page) */
.mv-bookmark-toggle-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 16px 20px 8px;
  padding: 12px 16px;
  border-radius: 12px;
  background: linear-gradient(135deg, #facc15, #f59e0b);
  color: #000;
  font-weight: 600;
  font-size: 14px;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.mv-bookmark-toggle-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
}

.mv-bookmark-toggle-btn svg {
  width: 14px;
  height: 14px;
  fill: currentColor;
}

.mv-bookmark-toggle-btn.mv-bookmark-remove {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
}

.mv-bookmark-toggle-btn.mv-bookmark-remove:hover {
  background: rgba(239, 68, 68, 0.25);
  box-shadow: none;
}

@media (max-width: 768px) {
  .mv-bookmark-toggle-btn.mv-bookmark-remove {
    background: rgba(239, 68, 68, 0.1);
  }
}

/* Bookmark list */
.mv-bookmark-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px 12px;
  -webkit-overflow-scrolling: touch;
}

.mv-bookmark-empty {
  text-align: center;
  color: rgba(255, 255, 255, 0.4);
  font-size: 14px;
  padding: 32px 16px;
}

@media (max-width: 768px) {
  .mv-bookmark-empty { color: rgba(0, 0, 0, 0.35); }
}

.mv-bookmark-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  margin-bottom: 4px;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.15s ease;
}

.mv-bookmark-item:hover {
  background: rgba(255, 255, 255, 0.08);
}

.mv-bookmark-item.mv-active {
  background: rgba(250, 204, 21, 0.12);
}

@media (max-width: 768px) {
  .mv-bookmark-item:hover { background: rgba(0, 0, 0, 0.05); }
  .mv-bookmark-item.mv-active { background: rgba(250, 204, 21, 0.1); }
}

.mv-bookmark-item-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
  flex: 1;
  min-width: 0;
}

.mv-bookmark-item-page {
  font-size: 12px;
  color: #facc15;
  font-weight: 600;
}

.mv-bookmark-item-title {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.85);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@media (max-width: 768px) {
  .mv-bookmark-item-title { color: #333; }
  .mv-bookmark-item-page { color: #f59e0b; }
}

.mv-bookmark-item-delete {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.3);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.15s ease;
  margin-left: 8px;
}

.mv-bookmark-item-delete:hover {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

@media (max-width: 768px) {
  .mv-bookmark-item-delete { color: rgba(0, 0, 0, 0.25); }
  .mv-bookmark-item-delete:hover { color: #ef4444; }
}

/* ===== SVG icon defaults inside viewer ===== */
.mv-container svg {
  display: inline-block;
  vertical-align: middle;
}
`;function escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function el(t,e={},i=[]){const o=document.createElement(t);for(const[t,i]of Object.entries(e))"style"===t&&"object"==typeof i?Object.assign(o.style,i):"className"===t?o.className=i:t.startsWith("on")&&"function"==typeof i?o.addEventListener(t.slice(2).toLowerCase(),i):"innerHTML"===t?o.innerHTML=i:o.setAttribute(t,i);for(const t of Array.isArray(i)?i:[i])"string"==typeof t?o.appendChild(document.createTextNode(t)):t&&o.appendChild(t);return o}class BookmarkManager{constructor(t={}){this._api=t.bookmarkApi||null,this._headers=t.bookmarkHeaders||{},this._id=t.bookmarkId||this._hashString(location.pathname),this._storageKey=`mv-bookmarks-${this._id}`,this._maxBookmarks=20,this._bookmarks=[],this._onChange=t.onBookmarkChange||null}_hashString(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i)|0;return Math.abs(e).toString(36)}async load(){if(this._api)try{const t=await fetch(`${this._api}?work_id=${encodeURIComponent(this._id)}`,{headers:this._headers}),e=await t.json();e.success&&(this._bookmarks=e.bookmarks||[])}catch(t){this._loadLocal()}else this._loadLocal();return this._bookmarks}_loadLocal(){try{const t=localStorage.getItem(this._storageKey);this._bookmarks=t?JSON.parse(t):[]}catch(t){this._bookmarks=[]}}_saveLocal(){try{localStorage.setItem(this._storageKey,JSON.stringify(this._bookmarks))}catch(t){}}_notify(){"function"==typeof this._onChange&&this._onChange([...this._bookmarks])}get bookmarks(){return this._bookmarks}has(t){return this._bookmarks.some(e=>e.page_number===t)}async add(t,e){if(this._bookmarks.length>=this._maxBookmarks&&!this.has(t))return{success:!1,error:`しおりは${this._maxBookmarks}個までです`};if(e=e||`ページ${t}`,this._api)try{const i=await fetch(this._api,{method:"POST",headers:{"Content-Type":"application/json",...this._headers},body:JSON.stringify({work_id:this._id,page_number:t,title:e})}),o=await i.json();if(o.success){const i=this._bookmarks.findIndex(e=>e.page_number===t);i>=0?this._bookmarks[i].title=e:this._bookmarks.push({page_number:t,title:e}),this._bookmarks.sort((t,e)=>t.page_number-e.page_number),this._notify()}return o}catch(t){return{success:!1,error:t.message}}const i=this._bookmarks.findIndex(e=>e.page_number===t);return i>=0?this._bookmarks[i].title=e:this._bookmarks.push({page_number:t,title:e}),this._bookmarks.sort((t,e)=>t.page_number-e.page_number),this._saveLocal(),this._notify(),{success:!0}}async remove(t){if(this._api)try{const e=await fetch(this._api,{method:"DELETE",headers:{"Content-Type":"application/json",...this._headers},body:JSON.stringify({work_id:this._id,page_number:t})}),i=await e.json();return i.success&&(this._bookmarks=this._bookmarks.filter(e=>e.page_number!==t),this._notify()),i}catch(t){return{success:!1,error:t.message}}return this._bookmarks=this._bookmarks.filter(e=>e.page_number!==t),this._saveLocal(),this._notify(),{success:!0}}}export default class MangaViewer{constructor(t={}){const e=Object.assign({container:"#viewer",pages:[],direction:"rtl",firstPageSingle:!0,viewMode:"page",adsense:null,previewLimit:null,onPageChange:null,onComplete:null,storageKey:"manga_progress",title:"",backUrl:"/",showHeader:!0,showFooter:!0,shareUrl:"",purchaseUrl:"",purchasePrice:"",loadingText:"Loading...",bookmarks:!0,bookmarkId:"",bookmarkApi:null,bookmarkHeaders:{},onBookmarkChange:null},t);if(this.opts=e,this._host="string"==typeof e.container?document.querySelector(e.container):e.container,!this._host)throw new Error("MangaViewer: container not found");if(this.shadowRoot=this._host.shadowRoot||this._host.attachShadow({mode:"open"}),this._root=this.shadowRoot,this._rawPages=this._normalisePages(e.pages),e.adsense&&e.adsense.client&&e.adsense.slot&&this._rawPages.push({type:"adsense",client:e.adsense.client,slot:e.adsense.slot,backgroundColor:"#1a1a1a",isInsert:!0}),this._totalOriginalPages=this._rawPages.filter(t=>!t.isInsert).length,this._hasPreviewLimit=null!=e.previewLimit&&e.previewLimit>0,this._hasPreviewLimit){let t=0;const i=[];for(const o of this._rawPages)if(o.isInsert)i.push(o);else{if(t++,t>e.previewLimit)break;i.push(o)}i.push({type:"purchase",isPurchasePage:!0}),this._rawPages=i}this._pages=this._rawPages,this._totalPages=this._pages.length,this._currentSlotIndex=0,this._slots=[],this._spreadMode=!1,this._uiVisible=!0,this._containerWidth=0,this._isDragging=!1,this._startX=0,this._currentX=0,this._offsetX=0,this._dragStartTime=0,this._currentZoom=1,this._MIN_ZOOM=1,this._MAX_ZOOM=3,this._ZOOM_STEP=.5,this._zoomPanX=0,this._zoomPanY=0,this._isZoomPanning=!1,this._zoomPanStartX=0,this._zoomPanStartY=0,this._zoomPanOffsetX=0,this._zoomPanOffsetY=0,this._velocityX=0,this._velocityY=0,this._lastMoveTime=0,this._lastMoveX=0,this._lastMoveY=0,this._momentumID=null,this._velocityHistory=[],this._momentumStartTime=0,this._momentumInitialVelocityX=0,this._momentumInitialVelocityY=0,this._bounceAnimationID=null,this._bounceVelocityX=0,this._bounceVelocityY=0,this._isOverscrolling=!1,this._initialPinchDistance=0,this._initialPinchZoom=1,this._pinchCenterX=0,this._pinchCenterY=0,this._zoomPanStartXBackup=0,this._zoomPanStartYBackup=0,this._DOUBLE_TAP_DELAY=300,this._lastTapTime=0,this._pendingTapAction=null,this._lastTouchEndTime=0,this._lastTouchX=0,this._lastTouchY=0,this._edgeSwipeStartX=0,this._edgeOverscroll=0,this._isMobile=window.matchMedia("(max-width: 768px)").matches,this._isTouchDevice="ontouchstart"in window,this._wheelCooldownUntil=0,this._bound={},this._bookmarkMgr=null,this._bookmarkPanelOpen=!1,this._build(),this._init()}_normalisePages(t){return t.map((t,e)=>"string"==typeof t?{type:"image",src:t,pageIndex:e}:Object.assign({pageIndex:e},t))}_build(){const t=this.opts;this._root.replaceChildren();const e=el("style");e.textContent=MANGA_VIEWER_CSS,this._root.appendChild(e),this._loadingEl=el("div",{className:"mv-loading-screen"},[el("div",{className:"mv-loading-spinner"}),el("div",{className:"mv-loading-text"},t.loadingText)]),this._root.appendChild(this._loadingEl),this._statusBarCover=el("div",{className:"mv-status-bar-cover"}),this._container=el("div",{className:"mv-container"}),this._main=el("div",{className:"mv-main"}),this._slotTrack=el("div",{className:"mv-slot-track"}),this._main.appendChild(this._slotTrack),this._tapLeft=el("div",{className:"mv-tap-area mv-left"}),this._tapCenter=el("div",{className:"mv-tap-area mv-center"}),this._tapRight=el("div",{className:"mv-tap-area mv-right"}),this._main.appendChild(this._tapLeft),this._main.appendChild(this._tapCenter),this._main.appendChild(this._tapRight),this._container.appendChild(this._main),this._header=this._buildHeader(),t.showHeader||this._header.classList.add("mv-hidden"),this._container.appendChild(this._header),this._footer=this._buildFooter(),t.showFooter||this._footer.classList.add("mv-hidden"),this._container.appendChild(this._footer),this._zoomControls=el("div",{className:"mv-zoom-controls"}),this._zoomInBtn=el("button",{className:"mv-zoom-btn",title:"Zoom in",innerHTML:ICONS.searchPlus,onClick:()=>this.zoomIn()}),this._zoomResetBtn=el("button",{className:"mv-zoom-btn",title:"Reset zoom",innerHTML:ICONS.compressAlt,disabled:"disabled",onClick:()=>this.resetZoom()}),this._zoomControls.appendChild(this._zoomInBtn),this._zoomControls.appendChild(this._zoomResetBtn),this._container.appendChild(this._zoomControls),this._container.appendChild(this._statusBarCover),this._root.appendChild(this._container)}_buildHeader(){const t=this.opts,e=el("div",{className:"mv-header"}),i=el("a",{href:t.backUrl,className:"mv-header-btn",title:"Back",innerHTML:ICONS.chevronLeft});e.appendChild(i);const o=el("h1",{className:"mv-title"},t.title);e.appendChild(o);const s=el("div",{className:"mv-header-buttons"});this._bookmarkBtn=el("button",{className:"mv-header-btn mv-bookmark-btn",title:"Bookmarks",innerHTML:ICONS.bookmark});let a=!1,n=null;return this._bookmarkBtn.addEventListener("pointerdown",()=>{a=!1,n=setTimeout(()=>{a=!0,this._toggleBookmarkPanel()},500)}),this._bookmarkBtn.addEventListener("pointerup",()=>{clearTimeout(n),a||this._quickToggleBookmark()}),this._bookmarkBtn.addEventListener("pointerleave",()=>clearTimeout(n)),this.opts.bookmarks&&s.appendChild(this._bookmarkBtn),this._fullscreenBtn=el("button",{className:"mv-header-btn mv-pc-only",title:"Fullscreen",innerHTML:ICONS.expand,onClick:()=>this._toggleFullscreen()}),s.appendChild(this._fullscreenBtn),s.appendChild(el("button",{className:"mv-header-btn",title:"Share on X",innerHTML:ICONS.xLogo,onClick:()=>this._shareToX()})),s.appendChild(el("button",{className:"mv-header-btn",title:"Copy link",innerHTML:ICONS.link,onClick:()=>this._copyLink()})),s.appendChild(el("button",{className:"mv-header-btn",title:"Help",innerHTML:ICONS.question,onClick:()=>this._showHelp()})),e.appendChild(s),e}_buildFooter(){const t=this.opts,e=el("div",{className:"mv-footer"}),i=el("div",{className:"mv-footer-info"});return this._currentPageEl=el("span"),this._currentPageEl.textContent="1 / "+this._totalPages,this._progressEl=el("span"),this._progressEl.textContent="0%",i.appendChild(this._currentPageEl),i.appendChild(this._progressEl),e.appendChild(i),this._slider=el("input",{type:"range",className:"mv-page-slider"+("rtl"===t.direction?" mv-rtl-slider":""),min:"1",max:String(this._totalPages),value:"1"}),e.appendChild(this._slider),e}_init(){this._containerWidth=this._main.offsetWidth,this._checkOrientation(),"scroll"===this.opts.viewMode&&(this._main.classList.add("mv-scroll-mode"),this._slotTrack.classList.add("mv-scroll-track"),this._tapLeft.classList.add("mv-display-none"),this._tapRight.classList.add("mv-display-none"),this._zoomControls.classList.add("mv-display-none")),this._buildSlots(),this._renderSlots(),this._updateTrackPosition(!1),this._updateUI(),this._setupEvents();const t=this._loadProgress();t&&t.pageIndex>0&&this._showResumeDialog(t),setTimeout(()=>{this._loadingEl&&this._loadingEl.classList.add("mv-fade-out")},300),this.opts.bookmarks&&this._initBookmarks()}_buildSlots(){this._slots=[];const t=this._pages;if(this._spreadMode){let e=0;for(this.opts.firstPageSingle&&t.length>0&&(this._slots.push({pages:[0],spread:!0,hasBlank:!0}),e=1);e<t.length;){const i=t[e];"adsense"!==i.type&&"purchase"!==i.type?e+1<t.length&&"adsense"!==t[e+1].type&&"purchase"!==t[e+1].type?(this._slots.push({pages:[e,e+1],spread:!0}),e+=2):(this._slots.push({pages:[e],spread:!1}),e++):(this._slots.push({pages:[e],spread:!1}),e++)}}else t.forEach((t,e)=>this._slots.push({pages:[e],spread:!1}))}_renderSlots(){const t=this.opts.direction,e=!("scroll"===this.opts.viewMode)&&"rtl"===t,i=e?[...this._slots].reverse():this._slots;this._slotTrack.replaceChildren(),i.forEach((i,o)=>{const s=e?this._slots.length-1-o:o,a=["mv-page-slot"];i.spread&&(a.push("mv-spread-slot"),"rtl"===t&&a.push("mv-rtl-slot"));const n=el("div",{className:a.join(" "),"data-slot":String(s)}),r=el("div",{className:"mv-zoom-container","data-zoom-slot":String(s)});n.appendChild(r);const l=[];if(i.pages.forEach(t=>{const e=s<=2?"eager":"lazy";l.push(this._createPageNode(t,e))}),i.hasBlank){const e=el("div",{className:"mv-blank-page","aria-hidden":"true"});"rtl"===t?l.unshift(e):l.push(e)}l.forEach(t=>r.appendChild(t)),this._slotTrack.appendChild(n)}),this._slotTrack.querySelectorAll(".mv-blank-page").forEach(t=>{const e=t.parentElement.querySelector("img");if(e){const i=()=>{e.naturalWidth&&e.naturalHeight&&t.style.setProperty("--mv-blank-aspect-ratio",`${e.naturalWidth} / ${e.naturalHeight}`)};e.complete?i():e.addEventListener("load",i,{once:!0})}}),this._preloadNearby(),setTimeout(()=>this._initAds(),500)}_createPageNode(t,e){const i=this._pages[t];if("adsense"===i.type){const t=el("div",{className:"mv-adsense-page mv-page-fill mv-page-bg"});t.style.setProperty("--mv-page-bg",i.backgroundColor||"#1a1a1a");const e=el("div",{className:"mv-adsense-inner"}),o=el("ins",{className:"adsbygoogle mv-adsense-slot","data-ad-client":i.client||"","data-ad-slot":i.slot||"","data-ad-format":"auto","data-full-width-responsive":"true"});e.appendChild(o),t.appendChild(e);const s=el("div",{className:"mv-adsense-label"});return s.appendChild(el("p",{},"Ad")),t.appendChild(s),t}if("purchase"===i.type||i.isPurchasePage)return el("div",{className:"mv-purchase-trigger mv-page-fill"});if("html"===i.type){const t=i.linkUrl?el("a",{href:i.linkUrl,target:i.linkTarget||"_blank",rel:"noopener noreferrer",className:"mv-page-fill mv-page-center mv-page-bg mv-page-link"}):el("div",{className:"mv-page-fill mv-page-center mv-page-bg"});return t.style.setProperty("--mv-page-bg",i.backgroundColor||"#000"),i.html&&(t.innerHTML=i.html),t}const o=el("img",{src:i.src||"",alt:`Page ${t+1}`,draggable:"false",loading:e,decoding:"async"});if(!i.linkUrl)return o;const s=el("a",{href:i.linkUrl,target:i.linkTarget||"_blank",rel:"noopener noreferrer",className:"mv-page-center mv-page-bg mv-page-link"});return i.backgroundColor&&s.style.setProperty("--mv-page-bg",i.backgroundColor),s.appendChild(o),s}_initAds(){if(void 0!==window.adsbygoogle)try{this.shadowRoot.querySelectorAll(".adsbygoogle").forEach(t=>{t.getAttribute("data-adsbygoogle-status")||(window.adsbygoogle=window.adsbygoogle||[]).push({})})}catch(t){}}_preloadNearby(){for(let t=1;t<=5;t++)[this._currentSlotIndex+t,this._currentSlotIndex-t].forEach(t=>{if(t<0||t>=this._slots.length)return;const e=this._slotTrack.querySelector(`.mv-page-slot[data-slot="${t}"]`);e&&e.querySelectorAll('img[loading="lazy"]').forEach(t=>{t.complete||t.dataset.preloaded||(t.loading="eager",t.dataset.preloaded="true")})})}_checkOrientation(){if("scroll"===this.opts.viewMode)return void(this._spreadMode=!1);const t=window.innerWidth>window.innerHeight,e=this._spreadMode;if(this._spreadMode=t,e!==this._spreadMode&&this._slots.length>0){const t=this._getCurrentPageIndex();this._buildSlots(),this._renderSlots(),this._currentSlotIndex=this._findSlotByPageIndex(t),this._updateTrackPosition(!1),this._updateUI()}}_setupEvents(){const t=(t,e,i,o)=>{const s=i.bind(this);t.addEventListener(e,s,o),this._bound._list||(this._bound._list=[]),this._bound._list.push([t,e,s,o])};"scroll"!==this.opts.viewMode?(t(this._main,"touchstart",this._onTouchStart,{passive:!1}),t(this._main,"touchmove",this._onTouchMove,{passive:!1}),t(this._main,"touchend",this._onTouchEnd),t(this._main,"mousedown",this._onMouseDown),t(this._main,"mousemove",this._onMouseMove),t(this._main,"mouseup",this._onMouseUp),t(this._main,"mouseleave",this._onMouseUp),t(this._tapLeft,"click",this._onTapLeft),t(this._tapRight,"click",this._onTapRight)):t(this._main,"scroll",this._onScroll),t(this._tapCenter,"click",this._onTapCenter),t(document,"keydown",this._onKeyDown),t(this._main,"wheel",this._onWheel,{passive:!1}),t(this._slider,"input",this._onSliderInput),t(window,"resize",this._onResize),t(window,"orientationchange",()=>setTimeout(()=>this._onResize(),100)),t(window,"beforeunload",()=>this._saveProgress()),t(document,"visibilitychange",()=>{"hidden"===document.visibilityState&&this._saveProgress()}),t(window,"pagehide",()=>this._saveProgress()),t(document,"fullscreenchange",()=>this._updateFullscreenIcon()),t(document,"webkitfullscreenchange",()=>this._updateFullscreenIcon())}_onResize(){this._containerWidth=this._main.offsetWidth,this._isMobile=window.matchMedia("(max-width: 768px)").matches,this._checkOrientation(),this._updateTrackPosition(!1)}_onTouchStart(t){if(this._stopMomentum(),2===t.touches.length){t.preventDefault();const e=this._getCurrentZoomContainer();e&&e.classList.add("mv-no-transition");const i=this._pinchDist(t.touches),o=this._pinchCenter(t.touches);return this._initialPinchDistance=i,this._initialPinchZoom=this._currentZoom,this._pinchCenterX=o.x-window.innerWidth/2,this._pinchCenterY=o.y-window.innerHeight/2,this._zoomPanStartXBackup=this._zoomPanX,this._zoomPanStartYBackup=this._zoomPanY,void(this._isDragging=!1)}if(this._currentZoom>1&&1===t.touches.length)return t.preventDefault(),void this._startZoomPan(t.touches[0].clientX,t.touches[0].clientY);1===t.touches.length&&this._startDrag(t.touches[0].clientX)}_onTouchMove(t){if(2===t.touches.length&&this._initialPinchDistance>0){t.preventDefault();const e=this._pinchDist(t.touches)/this._initialPinchDistance;let i=this._initialPinchZoom*e;if(this._initialPinchZoom>0){const t=i/this._initialPinchZoom;this._zoomPanX=this._pinchCenterX-(this._pinchCenterX-this._zoomPanStartXBackup)*t,this._zoomPanY=this._pinchCenterY-(this._pinchCenterY-this._zoomPanStartYBackup)*t}return void(i!==this._currentZoom&&this._setZoom(i))}if(this._isZoomPanning&&1===t.touches.length)return t.preventDefault(),void this._moveZoomPan(t.touches[0].clientX,t.touches[0].clientY);this._isDragging&&(t.preventDefault(),this._moveDrag(t.touches[0].clientX))}_onTouchEnd(t){if(this._initialPinchDistance>0){this._initialPinchDistance=0;const t=this._getCurrentZoomContainer();return t&&t.classList.remove("mv-no-transition"),void(this._currentZoom<1.1?this.resetZoom():this._currentZoom>this._MAX_ZOOM&&this._setZoom(this._MAX_ZOOM))}if(this._isZoomPanning){if(this._endZoomPan(),this._currentZoom>1){const t=Date.now(),e=Math.sqrt(Math.pow(this._zoomPanStartX-this._lastTouchX,2)+Math.pow(this._zoomPanStartY-this._lastTouchY,2));t-this._lastTouchEndTime<this._DOUBLE_TAP_DELAY&&e<50&&this.resetZoom(),this._lastTouchEndTime=t,this._lastTouchX=this._zoomPanStartX,this._lastTouchY=this._zoomPanStartY}}else this._endDrag()}_onMouseDown(t){if(this._stopMomentum(),this._currentZoom>1)return t.preventDefault(),void this._startZoomPan(t.clientX,t.clientY);t.preventDefault(),this._startDrag(t.clientX)}_onMouseMove(t){if(this._isZoomPanning)return t.preventDefault(),void this._moveZoomPan(t.clientX,t.clientY);this._isDragging&&(t.preventDefault(),this._moveDrag(t.clientX))}_onMouseUp(){this._isZoomPanning?this._endZoomPan():this._endDrag()}_startZoomPan(t,e){this._isZoomPanning=!0,this._edgeOverscroll=0;const i=this._getCurrentZoomContainer();i&&i.classList.add("mv-no-transition"),this._slotTrack.classList.add("mv-no-transition"),this._zoomPanStartX=t,this._zoomPanStartY=e,this._zoomPanOffsetX=this._zoomPanX,this._zoomPanOffsetY=this._zoomPanY,this._edgeSwipeStartX=t,this._lastMoveTime=Date.now(),this._lastMoveX=t,this._lastMoveY=e,this._velocityX=0,this._velocityY=0,this._velocityHistory=[]}_moveZoomPan(t,e){const i=t-this._zoomPanStartX,o=e-this._zoomPanStartY,s=Date.now(),a=s-this._lastMoveTime;if(a>0&&a<100){const i=(t-this._lastMoveX)/a*16,o=(e-this._lastMoveY)/a*16;this._velocityHistory.push({vx:i,vy:o,time:s}),this._velocityHistory.length>5&&this._velocityHistory.shift()}this._lastMoveTime=s,this._lastMoveX=t,this._lastMoveY=e;const n=this._updateZoomPan(this._zoomPanOffsetX+i,this._zoomPanOffsetY+o),r=t-this._edgeSwipeStartX,l=e-this._zoomPanStartY,h=Math.abs(r)>1.5*Math.abs(l);if(0!==n.overscroll){if(!h)return void(this._edgeOverscroll=0);if(this._edgeOverscroll=n.overscroll,this._velocityHistory=[],Math.abs(this._edgeOverscroll)<10)return;const t=.3*this._edgeOverscroll;const e=-("rtl"===this.opts.direction?this._slots.length-1-this._currentSlotIndex:this._currentSlotIndex)*this._containerWidth;this._slotTrack.style.setProperty("--mv-track-transform",`translateX(${e+t}px)`)}else this._edgeOverscroll=0}_endZoomPan(){if(this._isZoomPanning=!1,Math.abs(this._edgeOverscroll)<10)this._initMomentum();else{const t=this._getCurrentZoomContainer();t&&t.classList.remove("mv-no-transition")}this._slotTrack.classList.remove("mv-no-transition");if(Math.abs(this._edgeOverscroll)>120){("rtl"===this.opts.direction?this._edgeOverscroll>0:this._edgeOverscroll<0)?this._goNext(!0):this._goPrev(!0)}else this._updateTrackPosition(!0);this._edgeOverscroll=0}_startDrag(t){this._isDragging=!0,this._startX=t,this._currentX=t,this._offsetX=0,this._dragStartTime=Date.now(),this._slotTrack.classList.add("mv-no-transition")}_moveDrag(t){this._currentX=t;const e=this._currentX-this._startX,i=0===this._currentSlotIndex,o=this._currentSlotIndex===this._slots.length-1;this._offsetX=i&&e>0||o&&e<0?.3*e:e,this._updateTrackPosition(!1)}_endDrag(){if(!this._isDragging)return;if(this._isDragging=!1,this._slotTrack.classList.remove("mv-no-transition"),this._currentZoom>1)return this._offsetX=0,void this._updateTrackPosition(!0);const t=this._currentX-this._startX,e=Date.now()-this._dragStartTime,i=.15*this._containerWidth,o=e<300&&Math.abs(t)>30;(Math.abs(t)>i||o)&&("rtl"===this.opts.direction?t<0&&this._currentSlotIndex>0?this._currentSlotIndex--:t>0&&this._currentSlotIndex<this._slots.length-1&&this._currentSlotIndex++:t<0&&this._currentSlotIndex<this._slots.length-1?this._currentSlotIndex++:t>0&&this._currentSlotIndex>0&&this._currentSlotIndex--),this._offsetX=0,this._updateTrackPosition(!0),this._updateUI()}_onTapLeft(t){if(t.stopPropagation(),this._momentumID)return void this._stopMomentum();const e=Date.now(),i=e-this._lastTapTime;if(this._lastTapTime=e,this._currentZoom>1)i<this._DOUBLE_TAP_DELAY&&this.resetZoom();else{if(i<this._DOUBLE_TAP_DELAY&&"scroll"!==this.opts.viewMode)return this._pendingTapAction&&clearTimeout(this._pendingTapAction),void this._zoomAtPoint(2,t.clientX||.15*window.innerWidth,t.clientY||window.innerHeight/2);this._pendingTapAction&&clearTimeout(this._pendingTapAction),this._pendingTapAction=setTimeout(()=>{"rtl"===this.opts.direction?this._currentSlotIndex<this._slots.length-1&&(this._currentSlotIndex++,this._updateTrackPosition(!0),this._updateUI()):this._currentSlotIndex>0&&(this._currentSlotIndex--,this._updateTrackPosition(!0),this._updateUI())},this._DOUBLE_TAP_DELAY)}}_onTapCenter(t){if(t.stopPropagation(),this._momentumID)return void this._stopMomentum();const e=Date.now(),i=e-this._lastTapTime;if(this._lastTapTime=e,i<this._DOUBLE_TAP_DELAY&&"scroll"!==this.opts.viewMode)return this._pendingTapAction&&clearTimeout(this._pendingTapAction),void(this._currentZoom>1?this.resetZoom():this._zoomAtPoint(2,t.clientX||window.innerWidth/2,t.clientY||window.innerHeight/2));this._pendingTapAction&&clearTimeout(this._pendingTapAction),this._pendingTapAction=setTimeout(()=>this._toggleUI(),this._DOUBLE_TAP_DELAY)}_onTapRight(t){if(t.stopPropagation(),this._momentumID)return void this._stopMomentum();const e=Date.now(),i=e-this._lastTapTime;if(this._lastTapTime=e,this._currentZoom>1)i<this._DOUBLE_TAP_DELAY&&this.resetZoom();else{if(i<this._DOUBLE_TAP_DELAY&&"scroll"!==this.opts.viewMode)return this._pendingTapAction&&clearTimeout(this._pendingTapAction),void this._zoomAtPoint(2,t.clientX||.85*window.innerWidth,t.clientY||window.innerHeight/2);this._pendingTapAction&&clearTimeout(this._pendingTapAction),this._pendingTapAction=setTimeout(()=>{"rtl"===this.opts.direction?this._currentSlotIndex>0&&(this._currentSlotIndex--,this._updateTrackPosition(!0),this._updateUI()):this._currentSlotIndex<this._slots.length-1&&(this._currentSlotIndex++,this._updateTrackPosition(!0),this._updateUI())},this._DOUBLE_TAP_DELAY)}}_onKeyDown(t){const e=t.target,i=(e&&e.tagName||"").toUpperCase();if(!("INPUT"===i||"TEXTAREA"===i||"SELECT"===i||e&&e.isContentEditable))switch(t.key){case"ArrowLeft":t.preventDefault(),"rtl"===this.opts.direction?this._goNext(!0):this._goPrev(!0);break;case"ArrowRight":t.preventDefault(),"rtl"===this.opts.direction?this._goPrev(!0):this._goNext(!0);break;case" ":case"ArrowDown":case"PageDown":t.preventDefault(),this._goNext(!0);break;case"ArrowUp":case"PageUp":t.preventDefault(),this._goPrev(!0);break;case"Home":t.preventDefault(),this.goToSlot(0);break;case"End":t.preventDefault(),this.goToSlot(this._slots.length-1);break;case"Escape":this._currentZoom>1&&this.resetZoom()}}_onWheel(t){if("scroll"===this.opts.viewMode)return;if(t.ctrlKey)return;const e=t.deltaX||0,i=t.deltaY||0,o=Math.abs(e)>Math.abs(i)?e:i;if(Math.abs(o)<8)return;t.preventDefault();const s=Date.now();s<this._wheelCooldownUntil||(this._wheelCooldownUntil=s+160,o>0?this._goNext(!0):this._goPrev(!0))}_onSliderInput(t){this.goToPage(parseInt(t.target.value))}_onScroll(){if("scroll"!==this.opts.viewMode)return;const t=this._slotTrack.querySelectorAll(".mv-page-slot"),e=this._main.clientHeight,i=this._main.getBoundingClientRect();t.forEach((t,o)=>{const s=t.getBoundingClientRect(),a=s.top-i.top;a<=e/2&&a+s.height>=e/2&&this._currentSlotIndex!==o&&(this._currentSlotIndex=o,this._updateUI())})}_goNext(t=!0){this._currentZoom>1&&this._resetZoomOnPageChange(),this._currentSlotIndex<this._slots.length-1?(this._currentSlotIndex++,this._updateTrackPosition(t),this._updateUI()):this._updateTrackPosition(!0)}_goPrev(t=!0){this._currentZoom>1&&this._resetZoomOnPageChange(),this._currentSlotIndex>0?(this._currentSlotIndex--,this._updateTrackPosition(t),this._updateUI()):this._updateTrackPosition(!0)}goToSlot(t){if(t>=0&&t<this._slots.length){if(this._resetZoomOnPageChange(),this._currentSlotIndex=t,"scroll"===this.opts.viewMode){const e=this._slotTrack.querySelectorAll(".mv-page-slot");e[t]&&e[t].scrollIntoView({behavior:"smooth",block:"start"})}else this._updateTrackPosition(!0);this._updateUI()}}goToPage(t){this.goToSlot(this._findSlotByPageIndex(t-1))}_updateTrackPosition(t){if("scroll"===this.opts.viewMode)return;t?this._slotTrack.classList.remove("mv-no-transition"):this._slotTrack.classList.add("mv-no-transition");const e=-("rtl"===this.opts.direction?this._slots.length-1-this._currentSlotIndex:this._currentSlotIndex)*this._containerWidth;this._slotTrack.style.setProperty("--mv-track-transform",`translateX(${e+this._offsetX}px)`)}_updateUI(){const t=this._slots[this._currentSlotIndex];if(!t)return;const e=t.pages[0]+1,i=t.pages[t.pages.length-1]+1,o=t.spread&&t.pages.length>1?`${e}-${i}`:`${e}`;this._currentPageEl.textContent=`${o} / ${this._totalPages}`;const s=this._slots.length<=1?100:Math.round(this._currentSlotIndex/(this._slots.length-1)*100);this._progressEl.textContent=`${s}%`;const a=this._slots.length<=1?this._totalPages:1+Math.round(this._currentSlotIndex/(this._slots.length-1)*(this._totalPages-1));this._slider.value=a,this._saveProgress(),this._preloadNearby(),this._hasPreviewLimit&&this._currentSlotIndex===this._slots.length-1?this._showPurchasePopup():this._closePurchasePopup(),this._updateBookmarkBtn(),"function"==typeof this.opts.onPageChange&&this.opts.onPageChange(e,this._totalPages),"function"==typeof this.opts.onComplete&&this._currentSlotIndex===this._slots.length-1&&this.opts.onComplete()}_toggleUI(){this._uiVisible=!this._uiVisible,this._header.classList.toggle("mv-ui-hidden",!this._uiVisible),this._footer.classList.toggle("mv-ui-hidden",!this._uiVisible),"scroll"===this.opts.viewMode||this._isMobile||this._zoomControls.classList.toggle("mv-ui-hidden",!this._uiVisible),this._statusBarCover.classList.toggle("mv-visible",!this._uiVisible)}_getCurrentZoomContainer(){return this._slotTrack.querySelector(`.mv-zoom-container[data-zoom-slot="${this._currentSlotIndex}"]`)}_setZoom(t){this._currentZoom=Math.max(this._MIN_ZOOM,Math.min(this._MAX_ZOOM,t));const e=this._getCurrentZoomContainer();e&&(this._currentZoom>1?e.classList.add("mv-zoomed"):(e.classList.remove("mv-zoomed"),this._zoomPanX=0,this._zoomPanY=0),this._updateZoomTransform(e)),this._updateZoomButtons()}_zoomAtPoint(t,e,i){const o=this._getCurrentZoomContainer();if(!o)return;o.classList.remove("mv-no-transition");const s=e-window.innerWidth/2,a=i-window.innerHeight/2,n=t/(this._currentZoom||1);this._zoomPanX=s-(s-this._zoomPanX)*n,this._zoomPanY=a-(a-this._zoomPanY)*n,this._setZoom(t)}_updateZoomTransform(t){t||(t=this._getCurrentZoomContainer()),t&&t.style.setProperty("--mv-zoom-transform",`scale(${this._currentZoom}) translate(${this._zoomPanX/this._currentZoom}px, ${this._zoomPanY/this._currentZoom}px)`)}_updateZoomPan(t,e,i=!0){const o=this._getCurrentZoomContainer();if(!o)return{overscroll:0,overscrollY:0};const s=o.querySelectorAll("img");let a=0,n=0;if(s.length>0)s.forEach(t=>{const e=t.getBoundingClientRect();a+=e.width,n=Math.max(n,e.height)});else{const t=o.getBoundingClientRect();a=t.width,n=t.height}const r=window.innerWidth,l=window.innerHeight,h=.08*r,c=l/2,m=Math.max(0,(a-r)/2+h),d=Math.max(0,(n-l)/2+c),p=.15;let _=0,g=0;return t>m?(_=t-m,this._zoomPanX=i?m+_*p:m):t<-m?(_=t+m,this._zoomPanX=i?_*p-m:-m):(this._zoomPanX=t,_=0),e>d?(g=e-d,this._zoomPanY=i?d+g*p:d):e<-d?(g=e+d,this._zoomPanY=i?g*p-d:-d):(this._zoomPanY=e,g=0),this._isOverscrolling=0!==_||0!==g,this._updateZoomTransform(o),{overscroll:_,overscrollY:g}}zoomIn(){this._currentZoom>=this._MAX_ZOOM||this._setZoom(this._currentZoom+this._ZOOM_STEP)}resetZoom(){this._zoomPanX=0,this._zoomPanY=0,this._isOverscrolling=!1,this._setZoom(1),this._stopMomentum()}_updateZoomButtons(){this._zoomInBtn&&(this._zoomInBtn.disabled=this._currentZoom>=this._MAX_ZOOM),this._zoomResetBtn&&(this._zoomResetBtn.disabled=this._currentZoom<=this._MIN_ZOOM)}_resetZoomOnPageChange(){if(this._currentZoom>1){const t=this._getCurrentZoomContainer();t&&(t.classList.remove("mv-zoomed"),t.style.removeProperty("--mv-zoom-transform")),this._currentZoom=1,this._zoomPanX=0,this._zoomPanY=0,this._isOverscrolling=!1,this._updateZoomButtons(),this._stopMomentum()}}_stopMomentum(){this._momentumID&&(cancelAnimationFrame(this._momentumID),this._momentumID=null),this._bounceAnimationID&&(cancelAnimationFrame(this._bounceAnimationID),this._bounceAnimationID=null),this._velocityX=0,this._velocityY=0,this._bounceVelocityX=0,this._bounceVelocityY=0}_calculateAverageVelocity(){if(0===this._velocityHistory.length)return this._velocityX=0,void(this._velocityY=0);const t=Date.now(),e=this._velocityHistory.filter(e=>t-e.time<100);if(0===e.length)return this._velocityX=0,void(this._velocityY=0);let i=0,o=0,s=0;e.forEach((t,e)=>{const a=Math.pow(2,e);i+=t.vx*a,o+=t.vy*a,s+=a}),this._velocityX=i/s,this._velocityY=o/s;Math.sqrt(this._velocityX**2+this._velocityY**2)>2&&(this._velocityX*=1.2,this._velocityY*=1.2)}_initMomentum(){this._bounceAnimationID&&(cancelAnimationFrame(this._bounceAnimationID),this._bounceAnimationID=null,this._bounceVelocityX=0,this._bounceVelocityY=0),this._calculateAverageVelocity();const t=Math.sqrt(this._velocityX**2+this._velocityY**2);if(this._isOverscrolling)this._bounceBack(this._velocityX,this._velocityY);else{if(t<1){const t=this._getCurrentZoomContainer();return void(t&&t.classList.remove("mv-no-transition"))}this._momentumStartTime=performance.now(),this._momentumInitialVelocityX=this._velocityX,this._momentumInitialVelocityY=this._velocityY,this._momentumID=requestAnimationFrame(()=>this._runMomentum())}}_runMomentum(){const t=performance.now()-this._momentumStartTime,e=Math.exp(-t/325);this._velocityX=this._momentumInitialVelocityX*e,this._velocityY=this._momentumInitialVelocityY*e;if(Math.sqrt(this._velocityX**2+this._velocityY**2)<.5){if(this._isOverscrolling)this._bounceBack(this._velocityX,this._velocityY);else{const t=this._getCurrentZoomContainer();t&&t.classList.remove("mv-no-transition")}return void(this._momentumID=null)}const i=this._zoomPanX+this._velocityX,o=this._zoomPanY+this._velocityY,s=this._updateZoomPan(i,o,!0);if(0!==s.overscroll||0!==s.overscrollY)return this._bounceBack(this._velocityX,this._velocityY),void(this._momentumID=null);this._momentumID=requestAnimationFrame(()=>this._runMomentum())}_bounceBack(t=0,e=0){this._momentumID&&(cancelAnimationFrame(this._momentumID),this._momentumID=null);const i=this._getCurrentZoomContainer();if(!i)return;const o=i.querySelectorAll("img");let s=0,a=0;if(o.length>0)o.forEach(t=>{const e=t.getBoundingClientRect();s+=e.width,a=Math.max(a,e.height)});else{const t=i.getBoundingClientRect();s=t.width,a=t.height}const n=window.innerWidth,r=window.innerHeight,l=Math.max(0,(s-n)/2+.08*n),h=Math.max(0,(a-r)/2+r/2);0===t&&0===e||(this._bounceVelocityX=.15*t,this._bounceVelocityY=.15*e);const c=Math.max(-l,Math.min(l,this._zoomPanX)),m=Math.max(-h,Math.min(h,this._zoomPanY)),d=c-this._zoomPanX,p=m-this._zoomPanY;if(Math.abs(d)<.5&&Math.abs(p)<.5&&Math.abs(this._bounceVelocityX)<.5&&Math.abs(this._bounceVelocityY)<.5)return this._zoomPanX=c,this._zoomPanY=m,this._bounceVelocityX=0,this._bounceVelocityY=0,this._updateZoomTransform(i),i.classList.remove("mv-no-transition"),this._isOverscrolling=!1,void(this._bounceAnimationID=null);this._bounceVelocityX=.8*this._bounceVelocityX+.12*d,this._bounceVelocityY=.8*this._bounceVelocityY+.12*p,this._zoomPanX+=this._bounceVelocityX,this._zoomPanY+=this._bounceVelocityY,this._updateZoomTransform(i),this._bounceAnimationID=requestAnimationFrame(()=>this._bounceBack(0,0))}_pinchDist(t){const e=t[0].clientX-t[1].clientX,i=t[0].clientY-t[1].clientY;return Math.sqrt(e*e+i*i)}_pinchCenter(t){return{x:(t[0].clientX+t[1].clientX)/2,y:(t[0].clientY+t[1].clientY)/2}}_getCurrentPageIndex(){const t=this._slots[this._currentSlotIndex];return t?t.pages[0]:0}_findSlotByPageIndex(t){for(let e=0;e<this._slots.length;e++)if(this._slots[e].pages.includes(t))return e;return 0}_saveProgress(){const t=this._getCurrentPageIndex();try{localStorage.setItem(this.opts.storageKey,JSON.stringify({slotIndex:this._currentSlotIndex,pageIndex:t,timestamp:Date.now()}))}catch(t){}}_loadProgress(){try{const t=localStorage.getItem(this.opts.storageKey);if(t){const e=JSON.parse(t);if(Date.now()-e.timestamp<2592e6)return e}}catch(t){}return null}_showResumeDialog(t){const e=t.pageIndex+1,i=el("div",{className:"mv-resume-dialog"}),o=el("div",{className:"mv-resume-card"}),s=el("div",{className:"mv-resume-icon",innerHTML:'<svg viewBox="0 0 384 512" width="28" height="28" fill="#fff"><path d="M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4 13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"/></svg>'});o.appendChild(s),o.appendChild(el("div",{className:"mv-resume-title"},"Resume reading?")),o.appendChild(el("div",{className:"mv-resume-subtitle"},`Continue from page ${e}`));const a=el("div",{className:"mv-resume-buttons"});a.appendChild(el("button",{className:"mv-resume-btn mv-secondary",onClick:()=>{i.remove();try{localStorage.removeItem(this.opts.storageKey)}catch(t){}}},"Start over")),a.appendChild(el("button",{className:"mv-resume-btn mv-primary",innerHTML:ICONS.play+" Resume",onClick:()=>{i.remove(),setTimeout(()=>this.goToSlot(this._findSlotByPageIndex(t.pageIndex)),100)}})),o.appendChild(a),i.appendChild(o),this._root.appendChild(i)}_toggleFullscreen(){const t=this._container,e=!(!document.fullscreenElement&&!document.webkitFullscreenElement),i=t.classList.contains("mv-pseudo-fullscreen"),o=()=>{t.classList.add("mv-pseudo-fullscreen"),document.body.classList.add("mv-pseudo-fullscreen-body")};if(e||i){if(e)try{(document.exitFullscreen||document.webkitExitFullscreen).call(document)}catch(t){}return i&&(t.classList.remove("mv-pseudo-fullscreen"),document.body.classList.remove("mv-pseudo-fullscreen-body")),void this._updateFullscreenIcon()}const s=t.requestFullscreen||t.webkitRequestFullscreen;if(s)try{const e=s.call(t);e&&"function"==typeof e.catch&&e.catch(()=>o())}catch(t){o()}else o();this._updateFullscreenIcon()}_updateFullscreenIcon(){const t=!(!document.fullscreenElement&&!document.webkitFullscreenElement)||this._container.classList.contains("mv-pseudo-fullscreen");this._fullscreenBtn&&(this._fullscreenBtn.innerHTML=t?ICONS.compress:ICONS.expand)}_shareToX(){const t=this.opts.title?`Reading "${this.opts.title}"`:"",e=this.opts.shareUrl||window.location.href;window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(e)}`,"_blank","width=550,height=420")}_copyLink(){const t=this.opts.shareUrl||window.location.href;navigator.clipboard.writeText(t).then(()=>this._showToast("Link copied!")).catch(()=>{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this._showToast("Link copied!")})}_showToast(t){const e=this._root.querySelector(".mv-toast");e&&e.remove();const i=el("div",{className:"mv-toast",innerHTML:ICONS.check+" "+escapeHtml(t)});this._root.appendChild(i),setTimeout(()=>{i.classList.add("mv-fade-out"),setTimeout(()=>i.remove(),300)},2e3)}_showHelp(){const t="rtl"===this.opts.direction,e="scroll"===this.opts.viewMode?"Vertical scroll":"Page flip",i=t?"Right to left":"Left to right",o=this._isMobile,s="scroll"!==this.opts.viewMode;let a="";a=s?o?`\n        <div class="mv-help-item"><div class="mv-help-item-icon">👆</div><div class="mv-help-item-text"><div class="mv-help-item-label">Tap</div><div class="mv-help-item-desc">Left: ${t?"next":"prev"} page / Right: ${t?"prev":"next"} page / Center: toggle menu</div></div></div>\n        <div class="mv-help-item"><div class="mv-help-item-icon">👋</div><div class="mv-help-item-text"><div class="mv-help-item-label">Swipe</div><div class="mv-help-item-desc">Swipe left/right to turn pages</div></div></div>\n        <div class="mv-help-item"><div class="mv-help-item-icon">🔍</div><div class="mv-help-item-text"><div class="mv-help-item-label">Pinch</div><div class="mv-help-item-desc">Pinch to zoom, drag to pan. Drag to edge to turn page.</div></div></div>`:`\n        <div class="mv-help-item"><div class="mv-help-item-icon">🖱</div><div class="mv-help-item-text"><div class="mv-help-item-label">Click</div><div class="mv-help-item-desc">Left: ${t?"next":"prev"} / Right: ${t?"prev":"next"} / Center: menu</div></div></div>\n        <div class="mv-help-item"><div class="mv-help-item-icon">⌨</div><div class="mv-help-item-text"><div class="mv-help-item-label">Keyboard</div><div class="mv-help-item-desc">← → : page turn / Space: next / Esc: reset zoom</div></div></div>\n        <div class="mv-help-item"><div class="mv-help-item-icon">🔍</div><div class="mv-help-item-text"><div class="mv-help-item-label">Zoom</div><div class="mv-help-item-desc">Use buttons or double-click center to zoom</div></div></div>`:`<div class="mv-help-item"><div class="mv-help-item-icon">↕</div><div class="mv-help-item-text"><div class="mv-help-item-label">${o?"Swipe":"Scroll"}</div><div class="mv-help-item-desc">${o?"Swipe":"Scroll"} up/down to read</div></div></div>`;const n=el("div",{className:"mv-help-overlay",onClick:function(){this.remove()}});n.innerHTML=`<div class="mv-help-card" onclick="event.stopPropagation()">\n      <div class="mv-help-header">\n        <div class="mv-help-title">${ICONS.questionCircle} Help</div>\n        <button class="mv-help-close" onclick="this.closest('.mv-help-overlay').remove()">${ICONS.times}</button>\n      </div>\n      <div class="mv-help-content">\n        <div class="mv-help-section">\n          <div class="mv-help-section-title">⚙ Settings</div>\n          <div class="mv-help-item"><div class="mv-help-item-icon">📖</div><div class="mv-help-item-text"><div class="mv-help-item-label">${e}</div><div class="mv-help-item-desc">${s?"Direction: "+i:""}</div></div></div>\n        </div>\n        <div class="mv-help-section">\n          <div class="mv-help-section-title">👆 Controls</div>\n          ${a}\n        </div>\n      </div>\n    </div>`,this._root.appendChild(n)}_showPurchasePopup(){if(this._root.querySelector(".mv-purchase-popup"))return;const t=this.opts,e=el("div",{className:"mv-purchase-popup"});e.innerHTML=`<div class="mv-purchase-card">\n      <div class="mv-purchase-icon"><svg width="36" height="36" viewBox="0 0 24 24" fill="white"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>\n      <div class="mv-purchase-title">Preview ends here</div>\n      <p class="mv-purchase-desc">${this._totalOriginalPages} pages total — ${t.previewLimit} free</p>\n      <p class="mv-purchase-desc">Purchase to continue reading</p>\n      ${t.purchaseUrl?`<a href="${escapeHtml(t.purchaseUrl)}" class="mv-purchase-btn">Purchase ${t.purchasePrice?escapeHtml(t.purchasePrice):""}</a>`:""}\n      ${t.backUrl?`<a href="${escapeHtml(t.backUrl)}" class="mv-purchase-back">Go back</a>`:""}\n    </div>`,this._root.appendChild(e)}_closePurchasePopup(){const t=this._root.querySelector(".mv-purchase-popup");t&&t.remove()}async _initBookmarks(){this._bookmarkMgr=new BookmarkManager({bookmarkApi:this.opts.bookmarkApi,bookmarkHeaders:this.opts.bookmarkHeaders,bookmarkId:this.opts.bookmarkId,onBookmarkChange:this.opts.onBookmarkChange}),await this._bookmarkMgr.load(),this._buildBookmarkPanel(),this._updateBookmarkBtn()}_buildBookmarkPanel(){this._bookmarkPanel=el("div",{className:"mv-bookmark-panel"}),this._bookmarkOverlay=el("div",{className:"mv-bookmark-overlay",onClick:()=>this._toggleBookmarkPanel()});const t=el("div",{className:"mv-bookmark-panel-header"});t.appendChild(el("span",{className:"mv-bookmark-panel-title"},"しおり")),t.appendChild(el("button",{className:"mv-bookmark-panel-close",innerHTML:ICONS.times,onClick:()=>this._toggleBookmarkPanel()})),this._bookmarkPanel.appendChild(t),this._bookmarkToggleBtn=el("button",{className:"mv-bookmark-toggle-btn",onClick:()=>this._toggleCurrentPageBookmark()}),this._bookmarkPanel.appendChild(this._bookmarkToggleBtn),this._bookmarkList=el("div",{className:"mv-bookmark-list"}),this._bookmarkPanel.appendChild(this._bookmarkList),this._container.appendChild(this._bookmarkOverlay),this._container.appendChild(this._bookmarkPanel),this._renderBookmarkList()}_toggleBookmarkPanel(){this._bookmarkPanelOpen=!this._bookmarkPanelOpen,this._bookmarkPanel.classList.toggle("mv-open",this._bookmarkPanelOpen),this._bookmarkOverlay.classList.toggle("mv-open",this._bookmarkPanelOpen),this._bookmarkPanelOpen&&this._renderBookmarkList()}_renderBookmarkList(){if(!this._bookmarkMgr||!this._bookmarkList)return;const t=this._bookmarkMgr.bookmarks,e=this._getCurrentPageIndex()+1,i=this._bookmarkMgr.has(e);this._bookmarkToggleBtn.textContent="",this._bookmarkToggleBtn.innerHTML=i?ICONS.bookmark+" しおりを削除":ICONS.bookmark+" 現在のページをブックマーク",this._bookmarkToggleBtn.classList.toggle("mv-bookmark-remove",i),this._bookmarkList.innerHTML="",0!==t.length?t.forEach(t=>{const i=el("div",{className:"mv-bookmark-item"+(t.page_number===e?" mv-active":""),onClick:()=>{this.goToPage(t.page_number),this._toggleBookmarkPanel()}}),o=el("div",{className:"mv-bookmark-item-info"});o.appendChild(el("span",{className:"mv-bookmark-item-page"},`${t.page_number}ページ`)),o.appendChild(el("span",{className:"mv-bookmark-item-title"},t.title||`ページ${t.page_number}`)),i.appendChild(o);const s=el("button",{className:"mv-bookmark-item-delete",innerHTML:ICONS.times,onClick:e=>{e.stopPropagation(),this._bookmarkMgr.remove(t.page_number).then(()=>{this._renderBookmarkList(),this._updateBookmarkBtn()})}});i.appendChild(s),this._bookmarkList.appendChild(i)}):this._bookmarkList.appendChild(el("div",{className:"mv-bookmark-empty"},"しおりはまだありません"))}async _toggleCurrentPageBookmark(){if(!this._bookmarkMgr)return;const t=this._getCurrentPageIndex()+1;if(this._bookmarkMgr.has(t))await this._bookmarkMgr.remove(t),this._showToast("しおりを削除しました");else{const e=await this._bookmarkMgr.add(t);e.success?this._showToast("しおりを追加しました"):this._showToast(e.error||"エラーが発生しました")}this._renderBookmarkList(),this._updateBookmarkBtn()}async _quickToggleBookmark(){if(!this._bookmarkMgr)return;const t=this._getCurrentPageIndex()+1;if(this._bookmarkMgr.has(t))await this._bookmarkMgr.remove(t),this._showToast("しおりを削除しました");else{const e=await this._bookmarkMgr.add(t);e.success?this._showToast("しおりを追加しました"):this._showToast(e.error||"エラーが発生しました")}this._renderBookmarkList(),this._updateBookmarkBtn()}_updateBookmarkBtn(){if(!this._bookmarkMgr||!this._bookmarkBtn)return;const t=this._getCurrentPageIndex()+1,e=this._bookmarkMgr.has(t);this._bookmarkBtn.classList.toggle("mv-bookmark-active",e)}get currentPage(){return this._getCurrentPageIndex()+1}get totalPages(){return this._totalPages}get bookmarkManager(){return this._bookmarkMgr}destroy(){if(this._stopMomentum(),this._bound._list)for(const[t,e,i,o]of this._bound._list)t.removeEventListener(e,i,o);this._root.replaceChildren()}}